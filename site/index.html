<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Constellations - Footnote Comments</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
       
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #333333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
       
        .header h1 {
            font-size: 18px;
            color: #495057;
        }
       
        .header-actions {
            display: flex;
            gap: 15px;
        }
       
        .btn-overview {
            padding: 8px 16px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
       
        .btn-overview:hover {
            background: #0052a3;
        }
       
        /* Main layout */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
       
        /* Left panel - Documents */
        .left-panel {
            width: 20%;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 15px;
        }
       
        .lens-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
       
        .lens-tab {
            padding: 8px 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
       
        .lens-tab.active {
            color: #0066cc;
            border-bottom-color: #0066cc;
        }
       
        .doc-category {
            margin-bottom: 20px;
        }
       
        .doc-category h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }
       
        .document-item {
            background: white;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
       
        .document-item:hover {
            border-color: #0066cc;
        }
       
        .document-item.active {
            background: #e7f3ff;
            border-color: #0066cc;
        }

        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
       
        /* Center - Main content */
        .center-panel {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: white;
            position: relative;
        }
        
        /* Document Typography */
        .document-content {
            max-width: 700px;
            margin: 0 auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            font-size: 17px;
            line-height: 1.7;
            color: #333;
        }

        .document-content h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin: 2rem 0 1.5rem 0;
            line-height: 1.2;
            color: #1a1a1a;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
        }

        .document-content h2 {
            font-size: 1.7em;
            font-weight: 600;
            margin: 2rem 0 1rem 0;
            line-height: 1.3;
            color: #2c3e50;
        }

        .document-content h3 {
            font-size: 1.3em;
            font-weight: 600;
            margin: 1.5rem 0 0.8rem 0;
            line-height: 1.4;
            color: #34495e;
        }

        .document-content p {
            margin: 0 0 1.2rem 0;
        }

        .document-content ul, .document-content ol {
            margin: 0 0 1.2rem 0;
            padding-left: 2rem;
        }

        .document-content li {
            margin-bottom: 0.5rem;
            line-height: 1.7;
        }

        .document-content strong {
            font-weight: 600;
            color: #1a1a1a;
        }

        .document-content em {
            font-style: italic;
        }

        /* Footnote references in text */
        .footnote-ref {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            color: white;
            text-decoration: none;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            top: -2px;
        }
        
        .footnote-ref.question {
            background-color: #dc3545;
        }
        
        .footnote-ref.clarification {
            background-color: #ffc107;
            color: #856404;
        }
        
        .footnote-ref.approved {
            background-color: #28a745;
        }
        
        .footnote-ref:hover {
            transform: scale(1.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .footnote-ref.active {
            transform: scale(1.3);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        
        /* Right panel - Comments */
        .right-panel {
            width: 30%;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }
       
        .comments-header {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
       
        .comments-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
        }
       
        .new-comment-btn {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .new-comment-btn:hover {
            background: #218838;
        }
        
        .new-comment-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
       
        .comments-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .comment-item {
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        
        .comment-item:hover {
            border-color: #0066cc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .comment-item.active {
            background: #e7f3ff;
            border-color: #0066cc;
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .comment-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .comment-type {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .comment-type.question {
            background: #f8d7da;
            color: #721c24;
        }
        
        .comment-type.clarification {
            background: #fff3cd;
            color: #856404;
        }
        
        .comment-type.approved {
            background: #d4edda;
            color: #155724;
        }
        
        .comment-content {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .comment-meta {
            font-size: 11px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .comment-actions {
            display: flex;
            gap: 8px;
        }
        
        .comment-action {
            padding: 2px 6px;
            font-size: 10px;
            border: 1px solid #dee2e6;
            background: white;
            color: #6c757d;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .comment-action:hover {
            background: #f8f9fa;
            color: #495057;
        }
        
        /* New comment form */
        .comment-form {
            background: white;
            border-top: 1px solid #dee2e6;
            padding: 15px;
            display: none;
        }
        
        .comment-form.show {
            display: block;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-group select, .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-primary {
            background: #0066cc;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        /* Overview Modal */
        .overview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }
       
        .overview-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
       
        .overview-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            height: 80%;
            padding: 30px;
            position: relative;
            overflow: auto;
        }
       
        .overview-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
       
        .overview-graph {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-top: 20px;
        }
       
        .overview-section {
            border-left: 3px solid #0066cc;
            padding-left: 20px;
        }
       
        .overview-section h3 {
            color: #0066cc;
            margin-bottom: 10px;
        }
       
        .overview-items {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
       
        .overview-item {
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
            border: 1px solid #dee2e6;
        }
       
        .overview-item.stable {
            background: #d4edda;
            border-color: #28a745;
        }
       
        .overview-item.developing {
            background: #cce5ff;
            border-color: #0066cc;
        }
       
        .overview-item.draft {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        /* Selection highlighting for adding comments */
        .document-content.selection-mode {
            cursor: text;
        }
        
        .document-content.selection-mode ::selection {
            background-color: rgba(0, 102, 204, 0.3);
        }
        
        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Pattern Constellations Research</h1>
        <div class="header-actions">
            <button class="btn-overview" onclick="showOverview()">📊 Project Overview</button>
        </div>
    </div>
   
    <!-- Main container -->
    <div class="main-container">
        <!-- Left Panel - Documents -->
        <div class="left-panel">
            <div class="lens-tabs">
                <button class="lens-tab active" data-lens="all">All</button>
                <button class="lens-tab" data-lens="philosophy">Philosophy</button>
                <button class="lens-tab" data-lens="cognition">Cognition</button>
                <button class="lens-tab" data-lens="cs-math">CS/Math</button>
            </div>
            <!-- Categories will be added dynamically -->
        </div>
       
        <!-- Center - Main content -->
        <div class="center-panel" id="center-panel">
            <div style="max-width: 700px;">
                <div style="text-align: center; padding: 60px; color: #6c757d;">
                    <h2 style="color: #495057; margin-bottom: 10px;">Select a document to begin</h2>
                    <p>Choose a document from the left panel</p>
                </div>
            </div>
        </div>
       
        <!-- Right Panel - Comments -->
        <div class="right-panel">
            <div class="comments-header">
                <h3>Comments</h3>
                <button class="new-comment-btn" onclick="toggleCommentForm()" disabled>+ Add Comment</button>
            </div>
            <div class="comments-list" id="comments-list">
                <div class="loading">No document selected</div>
            </div>
            <!-- New comment form -->
            <div class="comment-form" id="comment-form">
                <div class="form-group">
                    <label>Comment Type</label>
                    <select id="comment-type">
                        <option value="question">❓ Question</option>
                        <option value="clarification">⚠️ Needs Clarification</option>
                        <option value="approved">✅ Approved/Keep</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Comment Text</label>
                    <textarea id="comment-text" placeholder="Enter your comment..."></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="cancelComment()">Cancel</button>
                    <button class="btn btn-primary" onclick="addComment()">Add Comment</button>
                </div>
            </div>
        </div>
    </div>
   
    <!-- Overview Modal -->
    <div class="overview-modal" id="overview-modal">
        <div class="overview-content">
            <span class="overview-close" onclick="hideOverview()">×</span>
            <h2>Project Overview - Pattern Recognition Identity</h2>
           
            <div class="overview-graph">
                <div class="overview-section">
                    <h3>🎯 Core Theory</h3>
                    <div class="overview-items">
                        <div class="overview-item developing">PRI Main Thesis</div>
                        <div class="overview-item developing">Pattern-Recognition Unity</div>
                        <div class="overview-item draft">Consciousness as Reflexive PR</div>
                    </div>
                </div>
               
                <div class="overview-section">
                    <h3>💡 Problem Dissolutions</h3>
                    <div class="overview-items">
                        <div class="overview-item stable">Hard Problem</div>
                        <div class="overview-item developing">Symbol Grounding</div>
                        <div class="overview-item draft">Quantum Measurement</div>
                        <div class="overview-item draft">Causation Problem</div>
                    </div>
                </div>
               
                <div class="overview-section">
                    <h3>📊 Empirical Evidence</h3>
                    <div class="overview-items">
                        <div class="overview-item developing">Semantic Embeddings</div>
                        <div class="overview-item developing">Rod-Cap Structure</div>
                        <div class="overview-item draft">LLM Analysis</div>
                    </div>
                </div>
               
                <div class="overview-section">
                    <h3>🔗 Connections</h3>
                    <div class="overview-items">
                        <div class="overview-item stable">Eastern Philosophy</div>
                        <div class="overview-item developing">Transformer Architecture</div>
                        <div class="overview-item draft">Hopfield Networks</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentDocument = null;
        let currentComments = [];
        let nextCommentNumber = 1;
        let isAddingComment = false;
        let userEmail = 'anonymous';
        let isInitialized = false;

        // Initialize the application
        async function init() {
            if (isInitialized) return;
            isInitialized = true;
            
            try {
                await fetchUserEmail();
                await buildLeftPanel();
                
                // Add lens tab functionality
                document.querySelectorAll('.lens-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.lens-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const lens = tab.dataset.lens;
                        document.querySelectorAll('.document-item').forEach(doc => {
                            const docLenses = doc.dataset.lenses ? doc.dataset.lenses.split(' ') : [];
                            doc.style.display = (lens === 'all' || docLenses.includes(lens)) ? 'block' : 'none';
                        });
                    });
                });
                
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        }

        // Fetch user email
        async function fetchUserEmail() {
            try {
                const res = await fetch('/api/user');
                const data = await res.json();
                userEmail = data.email || 'anonymous';
            } catch {
                userEmail = 'anonymous';
            }
        }

        // Load documents from GitHub
        async function loadDocuments() {
            try {
                console.log('Attempting to fetch documents from /site/data/documents.json...');
                const res = await fetch('/site/data/documents.json');
                if (!res.ok) {
                    console.error('Fetch failed with status:', res.status, res.statusText);
                    throw new Error(`Documents fetch failed: ${res.status} ${res.statusText}`);
                }
                const data = await res.json();
                console.log('Documents loaded:', data);
                return data;
            } catch (err) {
                console.error('Error loading documents:', err);
                const alternativePaths = [
                    '/data/documents.json',
                    '/documents.json',
                    '/content/documents.json'
                ];
                
                for (const path of alternativePaths) {
                    try {
                        console.log('Trying alternative path:', path);
                        const res2 = await fetch(path);
                        if (res2.ok) {
                            const docs = await res2.json();
                            console.log('Documents loaded from alternative path:', path, docs);
                            return docs;
                        }
                    } catch (err2) {
                        console.error(`Alternative path ${path} failed:`, err2);
                    }
                }
                return [];
            }
        }

        // Build left panel with documents from GitHub
        async function buildLeftPanel() {
            const leftPanel = document.querySelector('.left-panel');
            leftPanel.querySelectorAll('.doc-category, .error-message').forEach(el => el.remove());

            try {
                const docsData = await loadDocuments();
                console.log('Raw documents data:', docsData);
                
                if (!docsData || (!docsData.documents && !Array.isArray(docsData))) {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error-message';
                    errorMsg.textContent = 'No documents found - check console for details';
                    leftPanel.appendChild(errorMsg);
                    return;
                }
                
                // Handle different possible document structures
                let processedDocs = [];
                if (docsData.documents) {
                    processedDocs = Object.values(docsData.documents);
                } else if (Array.isArray(docsData)) {
                    processedDocs = docsData;
                } else {
                    processedDocs = Object.values(docsData);
                }
                
                console.log('Processed documents:', processedDocs);
                
                if (processedDocs.length === 0) {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error-message';
                    errorMsg.textContent = 'No documents available';
                    leftPanel.appendChild(errorMsg);
                    return;
                }

                // Group documents by category
                const categories = {};
                processedDocs.forEach(doc => {
                    const cat = doc.frontmatter?.category || 
                              doc.category || 
                              doc.meta?.category ||
                              'uncategorized';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(doc);
                });
                
                console.log('Categories:', categories);

                // Build UI for each category
                Object.keys(categories).sort().forEach(cat => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'doc-category';
                    
                    const h3 = document.createElement('h3');
                    h3.textContent = cat.toUpperCase();
                    categoryDiv.appendChild(h3);
                    
                    categories[cat].forEach(doc => {
                        const item = document.createElement('div');
                        item.className = 'document-item';
                        item.dataset.id = doc.id;
                        
                        const lenses = doc.frontmatter?.lens || doc.lens || doc.lenses || doc.tags || [];
                        item.dataset.lenses = Array.isArray(lenses) ? lenses.join(' ') : '';
                        
                        const title = doc.frontmatter?.title || 
                                    doc.title || 
                                    doc.name ||
                                    doc.filename ||
                                    doc.id ||
                                    'Untitled';
                        
                        const status = doc.frontmatter?.status ||
                                     doc.status || 
                                     doc.meta?.status ||
                                     'draft';
                        
                        item.innerHTML = `
                            <div>${title}</div>
                            <span style="font-size: 11px; color: #6c757d;">● ${status}</span>
                        `;
                        
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            console.log('Document clicked:', doc);
                            document.querySelectorAll('.document-item').forEach(i => i.classList.remove('active'));
                            item.classList.add('active');
                            
                            item.docData = doc;
                            loadDocument(doc);
                        });
                        
                        categoryDiv.appendChild(item);
                    });
                    
                    leftPanel.appendChild(categoryDiv);
                });
                
            } catch (error) {
                console.error('Error building left panel:', error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.innerHTML = `Error loading documents<br><small style="font-size:10px;">${error.message}</small>`;
                leftPanel.appendChild(errorMsg);
            }
        }

        // Load document content from GitHub
        async function loadDocument(doc) {
            currentDocument = doc;
            
            try {
                console.log('Loading document:', doc);
                
                let text = doc.fullContent || doc.content;
                if (!text) {
                    const filename = doc.filename || doc.id || `${doc.id}.md`;
                    const contentPath = `/content/${filename}`;
                    console.log('Fetching content from:', contentPath);
                    
                    const res = await fetch(contentPath);
                    if (!res.ok) {
                        throw new Error(`Failed to fetch content: ${res.status} ${res.statusText}`);
                    }
                    text = await res.text();
                    console.log('Content loaded successfully, length:', text.length);
                }
                
                // Parse markdown and extract footnotes
                const { content, footnotes } = parseMarkdownWithFootnotes(text);
                currentComments = footnotes;
                nextCommentNumber = Math.max(...footnotes.map(f => f.number), 0) + 1;
                
                console.log('Parsed footnotes:', footnotes);
                console.log('Next comment number:', nextCommentNumber);
                
                // Convert to HTML with footnote references
                const htmlContent = markdownToHtml(content);
                
                // Display content
                document.getElementById('center-panel').innerHTML = `
                    <article class="document-content" id="document-content">
                        ${htmlContent}
                    </article>
                `;
                
                // Display comments
                displayComments();
                
                // Add click handlers for footnote references
                addFootnoteClickHandlers();
                
                // Enable add comment button
                document.querySelector('.new-comment-btn').disabled = false;
                
            } catch (e) {
                console.error('Error loading document:', e);
                document.getElementById('center-panel').innerHTML = `
                    <div class="document-content">
                        <h2>Error loading document</h2>
                        <p style="color: #dc3545;">${e.message}</p>
                    </div>
                `;
            }
        }

        // Parse markdown and extract footnotes
        function parseMarkdownWithFootnotes(content) {
            const footnoteRefs = [];
            const footnoteDefinitions = {};
            
            // Extract footnote definitions [^n]: type:content:author:timestamp
            const definitionRegex = /^\[(\^[^\]]+)\]:\s*(.+)$/gm;
            let match;
            while ((match = definitionRegex.exec(content)) !== null) {
                const [fullMatch, ref, definition] = match;
                
                // Parse the definition to extract type and metadata
                const parts = definition.split(':');
                if (parts.length >= 4) {
                    const type = parts[0];
                    const text = parts[1];
                    const author = parts[2];
                    const timestamp = parseInt(parts[3]);
                    
                    footnoteDefinitions[ref] = {
                        ref: ref,
                        number: parseInt(ref.replace('^', '')),
                        type: type,
                        text: text,
                        author: author,
                        timestamp: timestamp
                    };
                }
                
                // Remove from content
                content = content.replace(fullMatch, '').trim();
            }
            
            // Convert footnote definitions to array
            const footnotes = Object.values(footnoteDefinitions).sort((a, b) => a.number - b.number);
            
            return { content, footnotes };
        }

        // Convert markdown to HTML with footnote handling
        function markdownToHtml(markdown) {
            let html = markdown;
            
            // Remove frontmatter
            html = html.replace(/^---[\s\S]*?---\n/, '');
            
            // Headers
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // Bold and italic
            html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Lists
            html = html.replace(/^\* (.+)$/gim, '<li>$1</li>');
            html = html.replace(/^- (.+)$/gim, '<li>$1</li>');
            html = html.replace(/^\d+\. (.+)$/gim, '<li>$1</li>');
            
            // Footnote references [^n]
            html = html.replace(/\[(\^[^\]]+)\]/g, (match, ref) => {
                const number = parseInt(ref.replace('^', ''));
                const footnote = currentComments.find(f => f.number === number);
                const type = footnote ? footnote.type : 'question';
                return `<a href="#comment-${number}" class="footnote-ref ${type}" data-comment-number="${number}">${number}</a>`;
            });
            
            // Paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            
            // Clean up empty paragraphs and fix header/list formatting
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[1-6]>)/g, '$1');
            html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<li>)/g, '<ul>$1');
            html = html.replace(/(<\/li>)<\/p>/g, '$1</ul>');
            
            return html;
        }

        // Display comments in right panel
        function displayComments() {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            
            if (currentComments.length === 0) {
                commentsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">No comments yet</div>';
                return;
            }
            
            currentComments.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.id = `comment-${comment.number}`;
                
                const typeDisplay = {
                    'question': '❓ Question',
                    'clarification': '⚠️ Clarification',
                    'approved': '✅ Approved'
                };
                
                commentItem.innerHTML = `
                    <div class="comment-header">
                        <div class="comment-number ${comment.type}">${comment.number}</div>
                        <div class="comment-type ${comment.type}">${typeDisplay[comment.type] || comment.type}</div>
                    </div>
                    <div class="comment-content">${comment.text}</div>
                    <div class="comment-meta">
                        <span>By ${comment.author} • ${new Date(comment.timestamp).toLocaleDateString()}</span>
                        <div class="comment-actions">
                            <button class="comment-action" onclick="editComment(${comment.number})">Edit</button>
                            <button class="comment-action" onclick="deleteComment(${comment.number})">Delete</button>
                        </div>
                    </div>
                `;
                
                // Add click handler to highlight in document
                commentItem.addEventListener('click', () => {
                    highlightCommentInDocument(comment.number);
                });
                
                commentsList.appendChild(commentItem);
            });
        }

        // Add click handlers for footnote references
        function addFootnoteClickHandlers() {
            document.querySelectorAll('.footnote-ref').forEach(ref => {
                ref.addEventListener('click', (e) => {
                    e.preventDefault();
                    const commentNumber = parseInt(ref.dataset.commentNumber);
                    highlightCommentInPanel(commentNumber);
                });
            });
        }

        // Highlight comment in document
        function highlightCommentInDocument(commentNumber) {
            // Remove existing highlights
            document.querySelectorAll('.footnote-ref').forEach(ref => {
                ref.classList.remove('active');
            });
            
            // Highlight the specific footnote reference
            const ref = document.querySelector(`[data-comment-number="${commentNumber}"]`);
            if (ref) {
                ref.classList.add('active');
                ref.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Highlight comment in panel
        function highlightCommentInPanel(commentNumber) {
            // Remove existing highlights
            document.querySelectorAll('.comment-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Highlight the specific comment
            const commentItem = document.getElementById(`comment-${commentNumber}`);
            if (commentItem) {
                commentItem.classList.add('active');
                commentItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Toggle comment form
        function toggleCommentForm() {
            const form = document.getElementById('comment-form');
            if (form.classList.contains('show')) {
                cancelComment();
            } else {
                form.classList.add('show');
                document.getElementById('comment-text').focus();
                isAddingComment = true;
                
                // Enable text selection mode
                const docContent = document.getElementById('document-content');
                if (docContent) {
                    docContent.classList.add('selection-mode');
                }
            }
        }

        // Cancel adding comment
        function cancelComment() {
            const form = document.getElementById('comment-form');
            form.classList.remove('show');
            document.getElementById('comment-text').value = '';
            isAddingComment = false;
            
            // Disable selection mode
            const docContent = document.getElementById('document-content');
            if (docContent) {
                docContent.classList.remove('selection-mode');
            }
            
            // Reset form button
            const addButton = form.querySelector('.btn-primary');
            addButton.textContent = 'Add Comment';
            addButton.onclick = addComment;
        }

        // Add new comment
        async function addComment() {
            const type = document.getElementById('comment-type').value;
            const text = document.getElementById('comment-text').value.trim();
            
            if (!text) {
                alert('Please enter comment text');
                return;
            }
            
            if (!currentDocument) {
                alert('Please select a document first');
                return;
            }
            
            // Get selected text or show selection prompt
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (!selectedText) {
                alert('Please select some text in the document to comment on');
                return;
            }
            
            // Create new comment
            const newComment = {
                number: nextCommentNumber,
                type: type,
                text: text,
                author: userEmail,
                timestamp: Date.now(),
                ref: `^${nextCommentNumber}`
            };
            
            // Insert footnote reference at selection
            insertFootnoteAtSelection(nextCommentNumber);
            
            // Add to current comments
            currentComments.push(newComment);
            currentComments.sort((a, b) => a.number - b.number);
            
            // Save to GitHub
            await saveCommentToGitHub(newComment);
            
            // Increment counter
            nextCommentNumber++;
            
            // Refresh display
            displayComments();
            addFootnoteClickHandlers();
            
            // Close form
            cancelComment();
        }

        // Insert footnote reference at current selection
        function insertFootnoteAtSelection(number) {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return;
            
            const range = selection.getRangeAt(0);
            
            // Create footnote reference element
            const footnoteRef = document.createElement('a');
            footnoteRef.href = `#comment-${number}`;
            footnoteRef.className = `footnote-ref ${document.getElementById('comment-type').value}`;
            footnoteRef.dataset.commentNumber = number;
            footnoteRef.textContent = number;
            
            // Insert at end of selection
            range.collapse(false); // Move to end of selection
            range.insertNode(footnoteRef);
            
            // Clear selection
            selection.removeAllRanges();
        }

        // Save comment to GitHub via API
        async function saveCommentToGitHub(comment) {
            try {
                const footnoteDefinition = `[^${comment.number}]: ${comment.type}:${comment.text}:${comment.author}:${comment.timestamp}`;
                
                console.log('Saving comment to GitHub:', footnoteDefinition);
                
                const response = await fetch('/api/save-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        docId: currentDocument.id,
                        comment: footnoteDefinition,
                        type: 'footnote',
                        action: 'add'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Failed to save comment to GitHub:', response.status, errorData);
                    alert('Failed to save comment to GitHub. It will be lost when you refresh.');
                    return;
                }
                
                const result = await response.json();
                console.log('Comment saved to GitHub successfully:', result);
                
            } catch (error) {
                console.error('Error saving comment to GitHub:', error);
                console.log('API endpoint not available - comment will be lost on refresh.');
            }
        }

        // Edit comment
        function editComment(commentNumber) {
            const comment = currentComments.find(c => c.number === commentNumber);
            if (!comment) return;
            
            // Show form with existing values
            document.getElementById('comment-type').value = comment.type;
            document.getElementById('comment-text').value = comment.text;
            
            const form = document.getElementById('comment-form');
            form.classList.add('show');
            
            // Change button behavior temporarily
            const addButton = form.querySelector('.btn-primary');
            addButton.textContent = 'Update Comment';
            addButton.onclick = () => updateComment(commentNumber);
        }

        // Update existing comment
        async function updateComment(commentNumber) {
            const type = document.getElementById('comment-type').value;
            const text = document.getElementById('comment-text').value.trim();
            
            if (!text) {
                alert('Please enter comment text');
                return;
            }
            
            // Update comment in array
            const comment = currentComments.find(c => c.number === commentNumber);
            if (comment) {
                const oldComment = {...comment};
                comment.type = type;
                comment.text = text;
                comment.timestamp = Date.now();
                
                // Update footnote reference styling
                const ref = document.querySelector(`[data-comment-number="${commentNumber}"]`);
                if (ref) {
                    ref.className = `footnote-ref ${type}`;
                }
                
                // Save to GitHub
                await updateCommentInGitHub(oldComment, comment);
                
                // Refresh display
                displayComments();
            }
            
            // Reset form
            cancelComment();
        }

        // Update comment in GitHub
        async function updateCommentInGitHub(oldComment, newComment) {
            try {
                const oldFootnoteDefinition = `[^${oldComment.number}]: ${oldComment.type}:${oldComment.text}:${oldComment.author}:${oldComment.timestamp}`;
                const newFootnoteDefinition = `[^${newComment.number}]: ${newComment.type}:${newComment.text}:${newComment.author}:${newComment.timestamp}`;
                
                console.log('Updating comment in GitHub:', { old: oldFootnoteDefinition, new: newFootnoteDefinition });
                
                const response = await fetch('/api/save-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        docId: currentDocument.id,
                        oldComment: oldFootnoteDefinition,
                        comment: newFootnoteDefinition,
                        type: 'footnote',
                        action: 'update'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Failed to update comment in GitHub:', response.status, errorData);
                    return;
                }
                
                const result = await response.json();
                console.log('Comment updated in GitHub successfully:', result);
                
            } catch (error) {
                console.error('Error updating comment in GitHub:', error);
            }
        }

        // Delete comment
        async function deleteComment(commentNumber) {
            if (!confirm('Are you sure you want to delete this comment?')) return;
            
            const comment = currentComments.find(c => c.number === commentNumber);
            if (!comment) return;
            
            // Remove from array
            currentComments = currentComments.filter(c => c.number !== commentNumber);
            
            // Remove footnote reference from document
            const ref = document.querySelector(`[data-comment-number="${commentNumber}"]`);
            if (ref) {
                ref.remove();
            }
            
            // Save to GitHub
            await deleteCommentFromGitHub(comment);
            
            // Refresh display
            displayComments();
        }

        // Delete comment from GitHub
        async function deleteCommentFromGitHub(comment) {
            try {
                const footnoteDefinition = `[^${comment.number}]: ${comment.type}:${comment.text}:${comment.author}:${comment.timestamp}`;
                
                console.log('Deleting comment from GitHub:', footnoteDefinition);
                
                const response = await fetch('/api/save-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        docId: currentDocument.id,
                        comment: footnoteDefinition,
                        type: 'footnote',
                        action: 'delete'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Failed to delete comment from GitHub:', response.status, errorData);
                    return;
                }
                
                const result = await response.json();
                console.log('Comment deleted from GitHub successfully:', result);
                
            } catch (error) {
                console.error('Error deleting comment from GitHub:', error);
            }
        }

        // Modal functions
        function showOverview() {
            document.getElementById('overview-modal').classList.add('show');
        }

        function hideOverview() {
            document.getElementById('overview-modal').classList.remove('show');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>