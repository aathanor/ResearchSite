<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Recognition Research Workspace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        /* Left Panel */
        #left-panel {
            width: 30%;
            background: #242424;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        
        .tabs {
            display: flex;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #888;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #fff;
            background: #242424;
            border-bottom: 2px solid #4a9eff;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .document {
            background: #2a2a2a;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .document:hover {
            background: #333;
        }
        
        .document h3 {
            margin-bottom: 8px;
            color: #4a9eff;
        }
        
        .document-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .status-draft { background: #444; }
        .status-developing { background: #4a5f00; }
        .status-stable { background: #1a4f1a; }
        
        /* Main Canvas */
        #canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
        }
        
        /* Lens Selector */
        .lens-selector {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(36, 36, 36, 0.9);
            padding: 8px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .lens-btn {
            padding: 8px 16px;
            border: 1px solid #444;
            background: transparent;
            color: #888;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .lens-btn.active {
            background: #4a9eff;
            color: white;
            border-color: #4a9eff;
        }
        
        /* Comment Markers */
        .comment-marker {
            position: absolute;
            font-size: 16px;
            cursor: pointer;
            user-select: none;
            z-index: 100;
        }
        
        .comment-marker.question { color: #ff4444; }
        .comment-marker.clarification { color: #4444ff; }
        .comment-marker.validated { color: #44ff44; }
        
        /* Context Menu */
        .context-menu {
            position: absolute;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 4px;
            display: none;
            z-index: 1000;
        }
        
        .context-menu.show {
            display: block;
        }
        
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .context-menu-item:hover {
            background: #333;
        }
        
        /* Document Viewer */
        .document-viewer {
            padding: 20px;
            line-height: 1.6;
            max-width: 800px;
        }
        
        .document-viewer h1 { 
            margin-bottom: 20px; 
            color: #4a9eff;
        }
        
        .document-viewer h2 { 
            margin: 20px 0 10px 0;
            color: #6ab7ff;
        }
        
        .document-viewer p {
            margin-bottom: 15px;
        }
        
        .inline-comment {
            display: inline-block;
            margin: 0 4px;
            font-size: 14px;
            vertical-align: super;
        }
    </style>
</head>
<body>
    <!-- Left Panel -->
    <div id="left-panel">
        <div class="tabs">
            <button class="tab active" data-tab="core">Core Texts</button>
            <button class="tab" data-tab="sources">Sources</button>
            <button class="tab" data-tab="notes">Working Notes</button>
        </div>
        <div class="panel-content" id="panel-content">
            <!-- Documents will be loaded here -->
        </div>
    </div>
    
    <!-- Main Canvas -->
    <div id="canvas-container">
        <!-- Lens Selector -->
        <div class="lens-selector">
            <button class="lens-btn active" data-lens="philosophy">Philosophy</button>
            <button class="lens-btn" data-lens="cognition">Cognition</button>
            <button class="lens-btn" data-lens="cs-math">CS/Math</button>
        </div>
        
        <canvas id="canvas"></canvas>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" data-action="question">
            <span>❓</span> Question to ask
        </div>
        <div class="context-menu-item" data-action="clarification">
            <span>❗</span> Needs clarification
        </div>
        <div class="context-menu-item" data-action="validated">
            <span>✅</span> OK, to keep
        </div>
    </div>
    
    <script>
        // Global state
        let documents = {};
        let tree = {};
        let currentLens = 'philosophy';
        let selectedNode = null;
        let selectedText = null;
        let selectedFile = null;
        let canvas, ctx;
        let zoom = 1;
        let panX = 0, panY = 0;
        
        // Initialize
        async function init() {
            // Load documents
            try {
                const response = await fetch('/data/documents.json');
                const data = await response.json();
                documents = data.documents;
                tree = data.tree;
                
                // Setup canvas
                setupCanvas();
                
                // Setup event listeners
                setupEventListeners();
                
                // Initial render
                renderDocumentList();
                renderCanvas();
                
            } catch (error) {
                console.error('Failed to load documents:', error);
            }
        }
        
        function setupCanvas() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            const container = document.getElementById('canvas-container');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            
            // Handle resize
            window.addEventListener('resize', () => {
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
                renderCanvas();
            });
        }
        
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    renderDocumentList(e.target.dataset.tab);
                });
            });
            
            // Lens switching
            document.querySelectorAll('.lens-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.lens-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentLens = e.target.dataset.lens;
                    renderCanvas();
                });
            });
            
            // Canvas interaction
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('wheel', handleCanvasZoom);
            
            // Context menu
            document.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('click', () => {
                document.getElementById('context-menu').classList.remove('show');
            });
            
            // Context menu actions
            document.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', handleCommentAction);
            });
        }
        
        function renderDocumentList(tab = 'core') {
            const content = document.getElementById('panel-content');
            content.innerHTML = '';
            
            // Filter documents based on tab and selected node
            Object.values(documents).forEach(doc => {
                if (selectedNode && doc.node !== selectedNode) return;
                
                const docEl = document.createElement('div');
                docEl.className = 'document';
                docEl.innerHTML = `
                    <h3>${doc.title}</h3>
                    <p>${doc.frontmatter.description || doc.content.substring(0, 100) + '...'}</p>
                    <span class="document-status status-${doc.status}">${doc.status}</span>
                `;
                
                docEl.addEventListener('click', () => displayDocument(doc));
                content.appendChild(docEl);
            });
        }
        
        function displayDocument(doc) {
            const content = document.getElementById('panel-content');
            selectedFile = doc.id;
            
            let html = `<div class="document-viewer">`;
            html += `<h1>${doc.title}</h1>`;
            
            // Process content with comments
            let processedContent = doc.html;
            doc.comments.forEach(comment => {
                const marker = `<span class="inline-comment comment-marker ${
                    comment.type === '?' ? 'question' : 
                    comment.type === '!' ? 'clarification' : 
                    'validated'
                }">${comment.type}</span>`;
                
                // This is simplified - in reality you'd need better position mapping
                processedContent = processedContent.replace(
                    `<!-- ${comment.type} ${comment.text} -->`,
                    marker
                );
            });
            
            html += processedContent;
            html += `</div>`;
            
            content.innerHTML = html;
        }
        
        function renderCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Save context
            ctx.save();
            
            // Apply transformations
            ctx.translate(panX, panY);
            ctx.scale(zoom, zoom);
            
            // Render nodes based on current lens
            const centerX = canvas.width / 2 / zoom;
            const centerY = canvas.height / 2 / zoom;
            
            renderNodes(centerX, centerY);
            
            // Restore context
            ctx.restore();
        }
        
        function renderNodes(centerX, centerY) {
            // This is simplified - you'd implement proper tree layout
            let angle = 0;
            const radius = 200;
            
            Object.values(tree).forEach(node => {
                // Check if node is relevant to current lens
                const relevantDocs = node.documents.filter(docId => {
                    const doc = documents[docId];
                    return doc && doc.lens.includes(currentLens);
                });
                
                if (relevantDocs.length === 0) return;
                
                // Calculate position
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                // Draw node
                ctx.fillStyle = selectedNode === node.id ? '#4a9eff' : '#444';
                ctx.beginPath();
                ctx.arc(x, y, 30, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw label
                ctx.fillStyle = '#fff';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(node.id, x, y + 50);
                
                angle += (Math.PI * 2) / Object.keys(tree).length;
            });
        }
        
        function handleCanvasClick(e) {
            // Simplified - would need proper hit detection
            // For now, just cycle through nodes
            const nodes = Object.keys(tree);
            const currentIndex = nodes.indexOf(selectedNode);
            selectedNode = nodes[(currentIndex + 1) % nodes.length];
            
            renderDocumentList();
            renderCanvas();
        }
        
        function handleCanvasZoom(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            zoom *= delta;
            zoom = Math.max(0.5, Math.min(3, zoom));
            renderCanvas();
        }
        
        function handleContextMenu(e) {
            e.preventDefault();
            
            const selection = window.getSelection();
            if (selection.toString().length > 0) {
                selectedText = selection.toString();
                
                const menu = document.getElementById('context-menu');
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                menu.classList.add('show');
            }
        }
        
        async function handleCommentAction(e) {
            const action = e.currentTarget.dataset.action;
            const typeMap = {
                'question': '?',
                'clarification': '!',
                'validated': '✓'
            };
            
            if (!selectedFile || !selectedText) return;
            
            try {
                // Find line number (simplified)
                const lineNumber = 0; // Would need proper calculation
                
                const response = await fetch('/api/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file: selectedFile,
                        position: 0,
                        type: typeMap[action],
                        lineNumber: lineNumber
                    })
                });
                
                if (response.ok) {
                    // Reload documents after GitHub rebuild
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
            }
        }
        
        // Start the app
        init();
    </script>
</body>
</html>