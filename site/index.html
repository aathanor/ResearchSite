<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Recognition Research</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #333333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header with lens tabs */
        .header {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 10px 20px;
        }
        
        .header h1 {
            font-size: 18px;
            color: #495057;
            margin-bottom: 10px;
        }
        
        .lens-tabs {
            display: flex;
            gap: 5px;
        }
        
        .lens-tab {
            padding: 8px 20px;
            background: white;
            border: 1px solid #dee2e6;
            border-bottom: none;
            cursor: pointer;
            color: #6c757d;
            transition: all 0.2s;
            border-radius: 5px 5px 0 0;
        }
        
        .lens-tab.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        
        /* Main layout */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Left panel - Documents */
        .left-panel {
            width: 25%;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 15px;
        }
        
        .doc-category {
            margin-bottom: 20px;
        }
        
        .doc-category h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .document-item {
            background: white;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        
        .document-item:hover {
            border-color: #0066cc;
        }
        
        .document-item.active {
            background: #e7f3ff;
            border-color: #0066cc;
        }
        
        .document-title {
            font-size: 14px;
            color: #212529;
            margin-bottom: 2px;
        }
        
        .document-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
        }
        
        .status-developing {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-stable {
            background: #d4edda;
            color: #155724;
        }
        
        .status-draft {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Center - Main content */
        .center-panel {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: white;
        }
        
        .document-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .document-header h1 {
            font-size: 24px;
            color: #212529;
            margin-bottom: 5px;
        }
        
        .document-meta {
            font-size: 13px;
            color: #6c757d;
        }
        
        .document-body {
            line-height: 1.7;
            font-size: 15px;
            color: #495057;
            max-width: 700px;
        }
        
        .document-body h1 { font-size: 20px; margin: 25px 0 10px 0; }
        .document-body h2 { font-size: 18px; margin: 20px 0 10px 0; }
        .document-body h3 { font-size: 16px; margin: 15px 0 8px 0; }
        .document-body p { margin-bottom: 15px; }
        
        /* Text selection for comments */
        .commentable {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .commentable:hover {
            background: #fffbf0;
        }
        
        /* Right panel - Emails */
        .right-panel {
            width: 25%;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 15px;
        }
        
        .emails-header {
            font-size: 12px;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .email-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        
        .email-item:hover {
            border-color: #0066cc;
        }
        
        .email-date {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 3px;
        }
        
        .email-subject {
            font-size: 13px;
            color: #212529;
            font-weight: 500;
            margin-bottom: 3px;
        }
        
        .email-preview {
            font-size: 12px;
            color: #6c757d;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Comment popup */
        .comment-popup {
            position: absolute;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 5px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .comment-popup.show {
            display: flex;
            gap: 5px;
        }
        
        .comment-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .comment-btn:hover {
            background: #f8f9fa;
        }
        
        .comment-marker {
            display: inline-block;
            font-size: 12px;
            margin: 0 2px;
            cursor: help;
        }
        
        .comment-marker.question { color: #dc3545; }
        .comment-marker.exclamation { color: #ffc107; }
        .comment-marker.check { color: #28a745; }
        
        /* Welcome state */
        .welcome {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }
        
        .welcome h2 {
            color: #495057;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Pattern Recognition Identity Research</h1>
        <div class="lens-tabs">
            <button class="lens-tab active" data-lens="all">All</button>
            <button class="lens-tab" data-lens="philosophy">Philosophy</button>
            <button class="lens-tab" data-lens="cognition">Cognition</button>
            <button class="lens-tab" data-lens="cs-math">CS/Math</button>
        </div>
    </div>
    
    <!-- Main container -->
    <div class="main-container">
        <!-- Left Panel - Documents -->
        <div class="left-panel" id="left-panel">
            <div class="doc-category">
                <h3>Core Theory</h3>
                <div id="core-docs"></div>
            </div>
            <div class="doc-category">
                <h3>Evidence</h3>
                <div id="evidence-docs"></div>
            </div>
            <div class="doc-category">
                <h3>References</h3>
                <div id="reference-docs"></div>
            </div>
        </div>
        
        <!-- Center - Main content -->
        <div class="center-panel" id="center-panel">
            <div class="welcome">
                <h2>Select a document to begin</h2>
                <p>Click on any document in the left panel</p>
            </div>
        </div>
        
        <!-- Right Panel - Emails -->
        <div class="right-panel" id="right-panel">
            <div class="emails-header">Email Correspondence</div>
            <div id="emails-list">
                <div class="email-item">
                    <div class="email-date">Nov 13, 2024</div>
                    <div class="email-subject">Re: PRI and Eastern Philosophy</div>
                    <div class="email-preview">I've been thinking about the connection...</div>
                </div>
                <div class="email-item">
                    <div class="email-date">Nov 10, 2024</div>
                    <div class="email-subject">Symbol Grounding Problem</div>
                    <div class="email-preview">The dissolution seems compelling but...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comment popup -->
    <div class="comment-popup" id="comment-popup">
        <button class="comment-btn" data-type="?">❓</button>
        <button class="comment-btn" data-type="!">❗</button>
        <button class="comment-btn" data-type="✓">✅</button>
    </div>
    
    <script>
        // Global state
        let documents = {};
        let emails = {};
        let currentLens = 'all';
        let selectedDoc = null;
        let selectedText = '';
        let selectedRange = null;
        
        // Initialize
        async function init() {
            try {
                // Load documents
                const response = await fetch('./data/documents.json');
                if (response.ok) {
                    const data = await response.json();
                    documents = data.documents || {};
                }
                
                // Load emails (if exists)
                try {
                    const emailResponse = await fetch('./data/emails.json');
                    if (emailResponse.ok) {
                        const emailData = await emailResponse.json();
                        emails = emailData.emails || {};
                    }
                } catch (e) {
                    console.log('No emails file yet');
                }
                
                // Setup event listeners
                setupEventListeners();
                
                // Initial render
                renderDocuments();
                renderEmails();
                
            } catch (error) {
                console.error('Failed to initialize:', error);
            }
        }
        
        function setupEventListeners() {
            // Lens tabs
            document.querySelectorAll('.lens-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.lens-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    currentLens = e.target.dataset.lens;
                    renderDocuments();
                });
            });
            
            // Comment buttons
            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', handleComment);
            });
            
            // Hide comment popup on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.comment-popup') && !e.target.closest('.commentable')) {
                    document.getElementById('comment-popup').classList.remove('show');
                }
            });
        }
        
        function renderDocuments() {
            const coreContainer = document.getElementById('core-docs');
            const evidenceContainer = document.getElementById('evidence-docs');
            const referenceContainer = document.getElementById('reference-docs');
            
            // Clear containers
            coreContainer.innerHTML = '';
            evidenceContainer.innerHTML = '';
            referenceContainer.innerHTML = '';
            
            // Filter and render documents
            Object.values(documents).forEach(doc => {
                // Filter by lens
                if (currentLens !== 'all' && (!doc.lens || !doc.lens.includes(currentLens))) {
                    return;
                }
                
                // Create document element
                const docEl = document.createElement('div');
                docEl.className = 'document-item';
                docEl.innerHTML = `
                    <div class="document-title">${doc.title}</div>
                    <span class="document-status status-${doc.status}">${doc.status}</span>
                `;
                
                docEl.addEventListener('click', () => displayDocument(doc));
                
                // Add to appropriate category
                const category = doc.frontmatter.category || 'core';
                if (category === 'core') {
                    coreContainer.appendChild(docEl);
                } else if (category === 'evidence') {
                    evidenceContainer.appendChild(docEl);
                } else if (category === 'reference') {
                    referenceContainer.appendChild(docEl);
                } else {
                    coreContainer.appendChild(docEl); // default
                }
            });
        }
        
        function displayDocument(doc) {
            selectedDoc = doc;
            const centerPanel = document.getElementById('center-panel');
            
            // Mark active document
            document.querySelectorAll('.document-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Get clean content
            let content = doc.fullContent || doc.content || '';
            
            // Convert markdown to HTML (basic)
            let htmlContent = content
                .split('\n\n')
                .map(para => {
                    if (para.startsWith('# ')) return `<h1>${para.slice(2)}</h1>`;
                    if (para.startsWith('## ')) return `<h2>${para.slice(3)}</h2>`;
                    if (para.startsWith('### ')) return `<h3>${para.slice(4)}</h3>`;
                    if (para.trim()) return `<p class="commentable">${para}</p>`;
                    return '';
                })
                .join('');
            
            // Add existing comment markers
            if (doc.comments && doc.comments.length > 0) {
                doc.comments.forEach(comment => {
                    const marker = `<span class="comment-marker ${
                        comment.type === '?' ? 'question' : 
                        comment.type === '!' ? 'exclamation' : 'check'
                    }" title="Comment">${comment.type}</span>`;
                    // This is simplified - would need better positioning
                });
            }
            
            // Build metadata
            const meta = [];
            if (doc.frontmatter.date) meta.push(doc.frontmatter.date);
            if (doc.lens && doc.lens.length > 0) meta.push(doc.lens.join(', '));
            
            centerPanel.innerHTML = `
                <div class="document-header">
                    <h1>${doc.title}</h1>
                    <div class="document-meta">${meta.join(' • ')}</div>
                </div>
                <div class="document-body">
                    ${htmlContent}
                </div>
            `;
            
            // Add click handlers to paragraphs
            centerPanel.querySelectorAll('.commentable').forEach(el => {
                el.addEventListener('click', showCommentPopup);
            });
        }
        
        function showCommentPopup(e) {
            e.stopPropagation();
            
            const popup = document.getElementById('comment-popup');
            const selection = window.getSelection();
            
            // If there's selected text, use it
            if (selection.toString()) {
                selectedText = selection.toString();
                selectedRange = selection.getRangeAt(0);
            } else {
                // Otherwise, use the whole paragraph
                selectedText = e.target.textContent;
                selectedRange = e.target;
            }
            
            // Position popup near click
            popup.style.left = e.pageX + 'px';
            popup.style.top = (e.pageY - 40) + 'px';
            popup.classList.add('show');
        }
        
        async function handleComment(e) {
            const type = e.target.dataset.type;
            
            if (!selectedDoc) return;
            
            // Add visual marker immediately
            const marker = document.createElement('span');
            marker.className = `comment-marker ${
                type === '?' ? 'question' : 
                type === '!' ? 'exclamation' : 'check'
            }`;
            marker.textContent = type;
            
            if (selectedRange && selectedRange.insertNode) {
                selectedRange.insertNode(marker);
            } else if (selectedRange) {
                selectedRange.innerHTML += marker.outerHTML;
            }
            
            // Hide popup
            document.getElementById('comment-popup').classList.remove('show');
            
            // Send to backend
            try {
                const response = await fetch('./api/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file: selectedDoc.id,
                        type: type,
                        text: selectedText,
                        lineNumber: 0 // Would need to calculate
                    })
                });
                
                if (!response.ok) {
                    console.error('Failed to save comment');
                }
            } catch (error) {
                console.error('Error saving comment:', error);
            }
        }
        
        function renderEmails() {
            const emailsList = document.getElementById('emails-list');
            
            // For now, just show placeholder emails
            // Later, these would come from emails.json
        }
        
        // Start
        init();
    </script>
</body>
</html>