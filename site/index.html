<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Constellations - Footnote Comments</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
       
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #333333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
       
        .header h1 {
            font-size: 18px;
            color: #495057;
        }
       
        .header-actions {
            display: flex;
            gap: 15px;
        }
       
        .btn-overview {
            padding: 8px 16px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
       
        .btn-overview:hover {
            background: #0052a3;
        }
       
        /* Main layout */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
       
        /* Left panel - Documents */
        .left-panel {
            width: 20%;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 15px;
        }
       
        .lens-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
       
        .lens-tab {
            padding: 8px 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
       
        .lens-tab.active {
            color: #0066cc;
            border-bottom-color: #0066cc;
        }
       
        .doc-category {
            margin-bottom: 20px;
        }
       
        .doc-category h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 600;
        }
       
        .document-item {
            background: white;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
       
        .document-item:hover {
            border-color: #0066cc;
        }
       
        .document-item.active {
            background: #e7f3ff;
            border-color: #0066cc;
        }

        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
       
        /* Center - Main content */
        .center-panel {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: white;
            position: relative;
        }
        
        /* Document Typography */
        .document-content {
            max-width: 700px;
            margin: 0 auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            font-size: 17px;
            line-height: 1.7;
            color: #333;
        }

        .document-content h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin: 2rem 0 1.5rem 0;
            line-height: 1.2;
            color: #1a1a1a;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
        }

        .document-content h2 {
            font-size: 1.7em;
            font-weight: 600;
            margin: 2rem 0 1rem 0;
            line-height: 1.3;
            color: #2c3e50;
        }

        .document-content h3 {
            font-size: 1.3em;
            font-weight: 600;
            margin: 1.5rem 0 0.8rem 0;
            line-height: 1.4;
            color: #34495e;
        }

        .document-content p {
            margin: 0 0 1.2rem 0;
        }

        .document-content ul, .document-content ol {
            margin: 0 0 1.2rem 0;
            padding-left: 2rem;
        }

        .document-content li {
            margin-bottom: 0.5rem;
            line-height: 1.7;
        }

        .document-content strong {
            font-weight: 600;
            color: #1a1a1a;
        }

        .document-content em {
            font-style: italic;
        }

        /* Footnote references in text */
        .footnote-ref {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            color: white;
            text-decoration: none;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            top: -2px;
        }
        
        .footnote-ref.question {
            background-color: #dc3545;
        }
        
        .footnote-ref.clarification {
            background-color: #ffc107;
            color: #856404;
        }
        
        .footnote-ref.approved {
            background-color: #28a745;
        }
        
        .footnote-ref:hover {
            transform: scale(1.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .footnote-ref.active {
            transform: scale(1.3);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        
        /* Regular footnote links */
        .footnote-link {
            color: #0066cc;
            text-decoration: underline;
            font-size: 0.9em;
            cursor: pointer;
            position: relative;
            top: -2px;
        }
        
        .footnote-link:hover {
            color: #0052a3;
            text-decoration: none;
        }
        
        /* Footnotes section styling */
        .document-content hr {
            margin: 2rem 0;
            border: none;
            border-top: 1px solid #dee2e6;
        }
        
        .document-content h3 {
            font-size: 1.3em;
            font-weight: 600;
            margin: 1.5rem 0 0.8rem 0;
            line-height: 1.4;
            color: #34495e;
        }
        
        .document-content p[id^="footnote-"] {
            font-size: 0.9em;
            line-height: 1.6;
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        /* Right panel - Comments */
        .right-panel {
            width: 30%;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }
       
        .comments-header {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
       
        .comments-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
        }
       
        .comments-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .comment-item {
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        
        .comment-item:hover {
            border-color: #0066cc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .comment-item.active {
            background: #e7f3ff;
            border-color: #0066cc;
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .comment-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .comment-type {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .comment-type.question {
            background: #f8d7da;
            color: #721c24;
        }
        
        .comment-type.clarification {
            background: #fff3cd;
            color: #856404;
        }
        
        .comment-type.approved {
            background: #d4edda;
            color: #155724;
        }
        
        .comment-content {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .comment-meta {
            font-size: 11px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .comment-actions {
            display: flex;
            gap: 8px;
        }
        
        .comment-action {
            padding: 2px 6px;
            font-size: 10px;
            border: 1px solid #dee2e6;
            background: white;
            color: #6c757d;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .comment-action:hover {
            background: #f8f9fa;
            color: #495057;
        }
        
        /* New comment form */
        .comment-form {
            background: white;
            border-top: 1px solid #dee2e6;
            padding: 15px;
            display: none;
        }
        
        .comment-form.show {
            display: block;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-group select, .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-primary {
            background: #0066cc;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        /* Overview Modal */
        .overview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }
       
        .overview-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
       
        .overview-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            height: 80%;
            padding: 30px;
            position: relative;
            overflow: auto;
        }
       
        .overview-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
       
        .overview-graph {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-top: 20px;
        }
       
        .overview-section {
            border-left: 3px solid #0066cc;
            padding-left: 20px;
        }
       
        .overview-section h3 {
            color: #0066cc;
            margin-bottom: 10px;
        }
       
        .overview-items {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
       
        .overview-item {
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
            border: 1px solid #dee2e6;
        }
       
        .overview-item.stable {
            background: #d4edda;
            border-color: #28a745;
        }
       
        .overview-item.developing {
            background: #cce5ff;
            border-color: #0066cc;
        }
       
        .overview-item.draft {
            background: #fff3cd;
            border-color: #ffc107;
        }
        /* Comment Menu - Pop-up after text selection */
        .comment-menu {
            position: absolute;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 4px;
            display: none;
            z-index: 1000;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            min-width: 160px;
            animation: fadeIn 0.15s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
       
        .comment-menu.show {
            display: block;
        }
       
        .comment-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.15s;
            font-size: 13px;
            color: #495057;
            margin: 1px 0;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
       
        .comment-option:hover {
            background: #f8f9fa;
            color: #212529;
        }
        
        .comment-option:active {
            background: #e9ecef;
        }
       
        .comment-option-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }
       
        .comment-option-text {
            flex: 1;
            font-weight: 500;
        }
        
        /* Selected text highlighting */
        #document-content ::selection {
            background-color: rgba(0, 102, 204, 0.2);
        }
        
        #document-content::-moz-selection {
            background-color: rgba(0, 102, 204, 0.2);
        }
        
        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Pattern Constellations Research</h1>
        <div class="header-actions">
            <button class="btn-overview" onclick="showOverview()">📊 Project Overview</button>
        </div>
   
    <!-- Comment Menu - Pop-up after text selection -->
    <div class="comment-menu" id="comment-menu">
        <div class="comment-option" data-type="question" onclick="handleCommentOption('question')">
            <span class="comment-option-icon">❓</span>
            <span class="comment-option-text">Ask question</span>
        </div>
        <div class="comment-option" data-type="clarification" onclick="handleCommentOption('clarification')">
            <span class="comment-option-icon">⚠️</span>
            <span class="comment-option-text">Needs clarification</span>
        </div>
        <div class="comment-option" data-type="approved" onclick="handleCommentOption('approved')">
            <span class="comment-option-icon">✅</span>
            <span class="comment-option-text">Approved / Keep</span>
        </div>
    </div>
   
    <!-- Comment Dialog -->
    <div id="comment-dialog" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
         background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; z-index: 3000; 
         box-shadow: 0 8px 32px rgba(0,0,0,0.12); min-width: 400px;">
        <h3 id="comment-dialog-title" style="margin: 0 0 15px 0; color: #212529;">Comment</h3>
        <label id="comment-dialog-label" for="comment-dialog-text" style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057;"></label>
        <textarea id="comment-dialog-text" 
                  style="width: 100%; min-height: 80px; margin-top: 0; padding: 10px; border: 1px solid #dee2e6; 
                         border-radius: 4px; font-family: inherit; resize: vertical; font-size: 14px;"
                  onkeydown="if(event.key==='Enter' && (event.ctrlKey || event.metaKey)) submitComment()"></textarea>
        <div style="margin-top: 15px; text-align: right;">
            <button onclick="hideCommentDialog()" 
                    style="margin-right: 10px; padding: 8px 16px; border: 1px solid #dee2e6; background: white; 
                           border-radius: 4px; cursor: pointer; color: #6c757d;">Cancel</button>
            <button onclick="submitComment()" 
                    style="padding: 8px 16px; background: #0066cc; color: white; border: none; border-radius: 4px; 
                           cursor: pointer; font-weight: 500;">Submit</button>
        </div>
        <div style="margin-top: 8px; font-size: 12px; color: #6c757d; text-align: right;">
            Press Ctrl+Enter to submit
        </div>
    </div>
    </div>
   
    <!-- Main container -->
    <div class="main-container">
        <!-- Left Panel - Documents -->
        <div class="left-panel">
            <div class="lens-tabs">
                <button class="lens-tab active" data-lens="all">All</button>
                <button class="lens-tab" data-lens="philosophy">Philosophy</button>
                <button class="lens-tab" data-lens="cognition">Cognition</button>
                <button class="lens-tab" data-lens="cs-math">CS/Math</button>
            </div>
            <!-- Categories will be added dynamically -->
        </div>
       
        <!-- Center - Main content -->
        <div class="center-panel" id="center-panel">
            <div style="max-width: 700px;">
                <div style="text-align: center; padding: 60px; color: #6c757d;">
                    <h2 style="color: #495057; margin-bottom: 10px;">Select a document to begin</h2>
                    <p>Choose a document from the left panel</p>
                </div>
            </div>
        </div>
       
        <!-- Right Panel - Comments -->
        <div class="right-panel">
            <div class="comments-header">
                <h3>Comments</h3>
            </div>
            <div class="comments-list" id="comments-list">
                <div class="loading">No document selected</div>
            </div>
        </div>
    </div>
   
    <!-- Overview Modal -->
    <div class="overview-modal" id="overview-modal">
        <div class="overview-content">
            <span class="overview-close" onclick="hideOverview()">×</span>
            <h2>Project Overview - Pattern Recognition Identity</h2>
           
            <div class="overview-graph">
                <div class="overview-section">
                    <h3>🎯 Core Theory</h3>
                    <div class="overview-items">
                        <div class="overview-item developing">PRI Main Thesis</div>
                        <div class="overview-item developing">Pattern-Recognition Unity</div>
                        <div class="overview-item draft">Consciousness as Reflexive PR</div>
                    </div>
                </div>
               
                <div class="overview-section">
                    <h3>💡 Problem Dissolutions</h3>
                    <div class="overview-items">
                        <div class="overview-item stable">Hard Problem</div>
                        <div class="overview-item developing">Symbol Grounding</div>
                        <div class="overview-item draft">Quantum Measurement</div>
                        <div class="overview-item draft">Causation Problem</div>
                    </div>
                </div>
               
                <div class="overview-section">
                    <h3>📊 Empirical Evidence</h3>
                    <div class="overview-items">
                        <div class="overview-item developing">Semantic Embeddings</div>
                        <div class="overview-item developing">Rod-Cap Structure</div>
                        <div class="overview-item draft">LLM Analysis</div>
                    </div>
                </div>
               
                <div class="overview-section">
                    <h3>🔗 Connections</h3>
                    <div class="overview-items">
                        <div class="overview-item stable">Eastern Philosophy</div>
                        <div class="overview-item developing">Transformer Architecture</div>
                        <div class="overview-item draft">Hopfield Networks</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentDocument = null;
        let currentComments = [];
        let nextCommentNumber = 1;
        let userEmail = 'anonymous';
        let isInitialized = false;
        let currentCommentRange = null;
        let currentCommentType = '';

        // Initialize the application
        async function init() {
            if (isInitialized) return;
            isInitialized = true;
            
            try {
                await fetchUserEmail();
                await buildLeftPanel();
                
                // Add lens tab functionality
                document.querySelectorAll('.lens-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.lens-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const lens = tab.dataset.lens;
                        document.querySelectorAll('.document-item').forEach(doc => {
                            const docLenses = doc.dataset.lenses ? doc.dataset.lenses.split(' ') : [];
                            doc.style.display = (lens === 'all' || docLenses.includes(lens)) ? 'block' : 'none';
                        });
                    });
                });
                
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        }

        // Fetch user email
        async function fetchUserEmail() {
            try {
                const res = await fetch('/api/user');
                const data = await res.json();
                userEmail = data.email || 'anonymous';
            } catch {
                userEmail = 'anonymous';
            }
        }

        // Load documents from GitHub
        async function loadDocuments() {
            try {
                console.log('Attempting to fetch documents from /site/data/documents.json...');
                const res = await fetch('/site/data/documents.json');
                if (!res.ok) {
                    console.error('Fetch failed with status:', res.status, res.statusText);
                    throw new Error(`Documents fetch failed: ${res.status} ${res.statusText}`);
                }
                const data = await res.json();
                console.log('Documents loaded:', data);
                return data;
            } catch (err) {
                console.error('Error loading documents:', err);
                const alternativePaths = [
                    '/data/documents.json',
                    '/documents.json',
                    '/content/documents.json'
                ];
                
                for (const path of alternativePaths) {
                    try {
                        console.log('Trying alternative path:', path);
                        const res2 = await fetch(path);
                        if (res2.ok) {
                            const docs = await res2.json();
                            console.log('Documents loaded from alternative path:', path, docs);
                            return docs;
                        }
                    } catch (err2) {
                        console.error(`Alternative path ${path} failed:`, err2);
                    }
                }
                return [];
            }
        }

        // Build left panel with documents from GitHub
        async function buildLeftPanel() {
            const leftPanel = document.querySelector('.left-panel');
            leftPanel.querySelectorAll('.doc-category, .error-message').forEach(el => el.remove());

            try {
                const docsData = await loadDocuments();
                console.log('Raw documents data:', docsData);
                
                if (!docsData || (!docsData.documents && !Array.isArray(docsData))) {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error-message';
                    errorMsg.textContent = 'No documents found - check console for details';
                    leftPanel.appendChild(errorMsg);
                    return;
                }
                
                // Handle different possible document structures
                let processedDocs = [];
                if (docsData.documents) {
                    processedDocs = Object.values(docsData.documents);
                } else if (Array.isArray(docsData)) {
                    processedDocs = docsData;
                } else {
                    processedDocs = Object.values(docsData);
                }
                
                console.log('Processed documents:', processedDocs);
                
                if (processedDocs.length === 0) {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error-message';
                    errorMsg.textContent = 'No documents available';
                    leftPanel.appendChild(errorMsg);
                    return;
                }

                // Group documents by category
                const categories = {};
                processedDocs.forEach(doc => {
                    const cat = doc.frontmatter?.category || 
                              doc.category || 
                              doc.meta?.category ||
                              'uncategorized';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(doc);
                });
                
                console.log('Categories:', categories);

                // Build UI for each category
                Object.keys(categories).sort().forEach(cat => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'doc-category';
                    
                    const h3 = document.createElement('h3');
                    h3.textContent = cat.toUpperCase();
                    categoryDiv.appendChild(h3);
                    
                    categories[cat].forEach(doc => {
                        const item = document.createElement('div');
                        item.className = 'document-item';
                        item.dataset.id = doc.id;
                        
                        const lenses = doc.frontmatter?.lens || doc.lens || doc.lenses || doc.tags || [];
                        item.dataset.lenses = Array.isArray(lenses) ? lenses.join(' ') : '';
                        
                        const title = doc.frontmatter?.title || 
                                    doc.title || 
                                    doc.name ||
                                    doc.filename ||
                                    doc.id ||
                                    'Untitled';
                        
                        const status = doc.frontmatter?.status ||
                                     doc.status || 
                                     doc.meta?.status ||
                                     'draft';
                        
                        item.innerHTML = `
                            <div>${title}</div>
                            <span style="font-size: 11px; color: #6c757d;">● ${status}</span>
                        `;
                        
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            console.log('Document clicked:', doc);
                            document.querySelectorAll('.document-item').forEach(i => i.classList.remove('active'));
                            item.classList.add('active');
                            
                            item.docData = doc;
                            loadDocument(doc);
                        });
                        
                        categoryDiv.appendChild(item);
                    });
                    
                    leftPanel.appendChild(categoryDiv);
                });
                
            } catch (error) {
                console.error('Error building left panel:', error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.innerHTML = `Error loading documents<br><small style="font-size:10px;">${error.message}</small>`;
                leftPanel.appendChild(errorMsg);
            }
        }

        // Load document content from GitHub
        async function loadDocument(doc) {
            currentDocument = doc;
            
            try {
                console.log('Loading document:', doc);
                
                let text = doc.fullContent || doc.content;
                if (!text) {
                    const filename = doc.filename || doc.id || `${doc.id}.md`;
                    const contentPath = `/content/${filename}`;
                    console.log('Fetching content from:', contentPath);
                    
                    const res = await fetch(contentPath);
                    if (!res.ok) {
                        throw new Error(`Failed to fetch content: ${res.status} ${res.statusText}`);
                    }
                    text = await res.text();
                    console.log('Content loaded successfully, length:', text.length);
                }
                
                // Parse markdown and extract footnotes
                const { content, footnotes } = parseMarkdownWithFootnotes(text);
                currentComments = footnotes;
                nextCommentNumber = Math.max(...footnotes.map(f => f.number), 0) + 1;
                
                console.log('Parsed footnotes:', footnotes);
                console.log('Next comment number:', nextCommentNumber);
                
                // Convert to HTML with footnote references
                const htmlContent = markdownToHtml(content);
                
                // Create footnotes section for regular footnotes
                const regularFootnotes = footnotes.filter(f => !f.isComment);
                let footnotesSection = '';
                
                if (regularFootnotes.length > 0) {
                    footnotesSection = '<hr style="margin: 2rem 0; border: none; border-top: 1px solid #dee2e6;"><h3>Footnotes</h3>';
                    regularFootnotes.forEach(footnote => {
                        footnotesSection += `<p id="footnote-${footnote.number}"><strong>${footnote.number}.</strong> ${footnote.text}</p>`;
                    });
                }
                
                // Display content
                document.getElementById('center-panel').innerHTML = `
                    <article class="document-content" id="document-content">
                        ${htmlContent}
                        ${footnotesSection}
                    </article>
                `;
                
                // Display comments
                displayComments();
                
                // Add click handlers for footnote references
                addFootnoteClickHandlers();
                
                // Add text selection handlers for comments
                addTextSelectionHandlers();
                
            } catch (e) {
                console.error('Error loading document:', e);
                document.getElementById('center-panel').innerHTML = `
                    <div class="document-content">
                        <h2>Error loading document</h2>
                        <p style="color: #dc3545;">${e.message}</p>
                    </div>
                `;
            }
        }

        // Debug function for testing (accessible from browser console)
        window.testCommentOption = function(type) {
            console.log('Testing comment option:', type);
            handleCommentOption(type || 'question');
        };
        
        // Debug function to check if elements exist
        window.debugCommentSystem = function() {
            console.log('=== Comment System Debug ===');
            console.log('Comment menu:', document.getElementById('comment-menu'));
            console.log('Comment options:', document.querySelectorAll('.comment-option'));
            console.log('Current range:', currentCommentRange);
            console.log('Document content:', document.getElementById('document-content'));
            console.log('============================');
        };

        // Add text selection handlers for commenting
        function addTextSelectionHandlers() {
            const docContent = document.getElementById('document-content');
            if (!docContent) return;
            
            console.log('Adding text selection handlers');
            
            // Remove existing listeners
            docContent.removeEventListener('mouseup', handleTextSelection);
            docContent.removeEventListener('contextmenu', preventContextMenu);
            
            // Add new listeners
            docContent.addEventListener('mouseup', handleTextSelection);
            docContent.addEventListener('contextmenu', preventContextMenu);
        }
        
        // Handle text selection
        function handleTextSelection(e) {
            setTimeout(() => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                
                console.log('Text selected:', selectedText);
                
                if (!selection.isCollapsed && selectedText.length > 0) {
                    const range = selection.getRangeAt(0);
                    const docContent = document.getElementById('document-content');
                    
                    // Check if selection is within the document content
                    if (!docContent.contains(range.commonAncestorContainer)) {
                        console.log('Selection not in document content');
                        return;
                    }
                    
                    const rect = range.getBoundingClientRect();
                    const menu = document.getElementById('comment-menu');
                    
                    // Position menu near selection
                    menu.style.left = Math.min(rect.left + window.scrollX, window.innerWidth - 200) + 'px';
                    menu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
                    menu.classList.add('show');
                    
                    // Store the range for later use
                    currentCommentRange = range.cloneRange();
                    
                    console.log('Comment menu shown at:', menu.style.left, menu.style.top);
                } else {
                    // Hide menu if no selection
                    document.getElementById('comment-menu').classList.remove('show');
                }
            }, 10);
        }
        
        // Prevent context menu on right click in document
        function preventContextMenu(e) {
            if (e.target.closest('#document-content')) {
                e.preventDefault();
            }
        }
        
        // Handle comment option selection
        function handleCommentOption(type) {
            console.log('=== handleCommentOption called ===');
            console.log('Type:', type);
            console.log('currentCommentRange:', currentCommentRange);
            
            const menu = document.getElementById('comment-menu');
            if (menu) {
                menu.classList.remove('show');
                console.log('Menu hidden');
            }
            
            if (!currentCommentRange) {
                console.error('No comment range available');
                alert('Error: No text selection found. Please select text first.');
                return;
            }
            
            currentCommentType = type;
            console.log('Comment type set to:', currentCommentType);
            
            try {
                if (type === 'approved') {
                    // For approved comments, add immediately
                    console.log('Adding approved comment immediately');
                    addComment(type, 'Approved', currentCommentRange);
                } else {
                    // For questions and clarifications, show dialog
                    console.log('Showing dialog for', type);
                    showCommentDialog(type);
                }
            } catch (error) {
                console.error('Error in handleCommentOption:', error);
                alert('Error processing comment: ' + error.message);
            }
            
            // Clear text selection
            window.getSelection().removeAllRanges();
            console.log('=== handleCommentOption complete ===');
        }

        // Parse markdown and extract footnotes
        function parseMarkdownWithFootnotes(content) {
            const footnoteRefs = [];
            const footnoteDefinitions = {};
            
            // Extract footnote definitions [^n]: content
            const definitionRegex = /^\[(\^[^\]]+)\]:\s*(.+)$/gm;
            let match;
            while ((match = definitionRegex.exec(content)) !== null) {
                const [fullMatch, ref, definition] = match;
                
                // Try to parse as comment footnote (type:text:author:timestamp)
                const parts = definition.split(':');
                if (parts.length >= 4 && ['question', 'clarification', 'approved'].includes(parts[0])) {
                    // This is a comment footnote
                    const type = parts[0];
                    const text = parts[1];
                    const author = parts[2];
                    const timestamp = parseInt(parts[3]);
                    
                    footnoteDefinitions[ref] = {
                        ref: ref,
                        number: parseInt(ref.replace('^', '')),
                        type: type,
                        text: text,
                        author: author,
                        timestamp: timestamp,
                        isComment: true
                    };
                } else {
                    // This is a regular footnote
                    footnoteDefinitions[ref] = {
                        ref: ref,
                        number: parseInt(ref.replace('^', '')),
                        type: 'regular',
                        text: definition,
                        author: '',
                        timestamp: 0,
                        isComment: false
                    };
                }
                
                // Remove from content
                content = content.replace(fullMatch, '').trim();
            }
            
            // Convert footnote definitions to array
            const footnotes = Object.values(footnoteDefinitions).sort((a, b) => a.number - b.number);
            
            return { content, footnotes };
        }

        // Convert markdown to HTML with footnote handling
        function markdownToHtml(markdown) {
            let html = markdown;
            
            // Remove frontmatter
            html = html.replace(/^---[\s\S]*?---\n/, '');
            
            // Headers
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // Bold and italic
            html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Lists
            html = html.replace(/^\* (.+)$/gim, '<li>$1</li>');
            html = html.replace(/^- (.+)$/gim, '<li>$1</li>');
            html = html.replace(/^\d+\. (.+)$/gim, '<li>$1</li>');
            
            // Footnote references [^n]
            html = html.replace(/\[(\^[^\]]+)\]/g, (match, ref) => {
                const number = parseInt(ref.replace('^', ''));
                const footnote = currentComments.find(f => f.number === number);
                
                if (footnote && footnote.isComment) {
                    // Comment footnote - colored circle
                    const type = footnote.type;
                    return `<a href="#comment-${number}" class="footnote-ref ${type}" data-comment-number="${number}">${number}</a>`;
                } else {
                    // Regular footnote - normal underlined link
                    return `<a href="#footnote-${number}" class="footnote-link" data-footnote-number="${number}">${number}</a>`;
                }
            });
            
            // Paragraphs
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            
            // Clean up empty paragraphs and fix header/list formatting
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>(<h[1-6]>)/g, '$1');
            html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
            html = html.replace(/<p>(<li>)/g, '<ul>$1');
            html = html.replace(/(<\/li>)<\/p>/g, '$1</ul>');
            
            return html;
        }

        // Display comments in right panel (only comment footnotes)
        function displayComments() {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            
            // Filter to only show comment footnotes, not regular footnotes
            const commentFootnotes = currentComments.filter(comment => comment.isComment);
            
            if (commentFootnotes.length === 0) {
                commentsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">No comments yet</div>';
                return;
            }
            
            commentFootnotes.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.id = `comment-${comment.number}`;
                
                const typeDisplay = {
                    'question': '❓ Question',
                    'clarification': '⚠️ Clarification',
                    'approved': '✅ Approved'
                };
                
                commentItem.innerHTML = `
                    <div class="comment-header">
                        <div class="comment-number ${comment.type}">${comment.number}</div>
                        <div class="comment-type ${comment.type}">${typeDisplay[comment.type] || comment.type}</div>
                    </div>
                    <div class="comment-content">${comment.text}</div>
                    <div class="comment-meta">
                        <span>By ${comment.author} • ${new Date(comment.timestamp).toLocaleDateString()}</span>
                        <div class="comment-actions">
                            <button class="comment-action" onclick="editComment(${comment.number})">Edit</button>
                            <button class="comment-action" onclick="deleteComment(${comment.number})">Delete</button>
                        </div>
                    </div>
                `;
                
                // Add click handler to highlight in document
                commentItem.addEventListener('click', () => {
                    highlightCommentInDocument(comment.number);
                });
                
                commentsList.appendChild(commentItem);
            });
        }

        // Add click handlers for footnote references
        function addFootnoteClickHandlers() {
            // Handle comment footnote references (colored circles)
            document.querySelectorAll('.footnote-ref').forEach(ref => {
                ref.addEventListener('click', (e) => {
                    e.preventDefault();
                    const commentNumber = parseInt(ref.dataset.commentNumber);
                    highlightCommentInPanel(commentNumber);
                });
            });
            
            // Handle regular footnote links (underlined)
            document.querySelectorAll('.footnote-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const footnoteNumber = parseInt(link.dataset.footnoteNumber);
                    const footnoteElement = document.getElementById(`footnote-${footnoteNumber}`);
                    if (footnoteElement) {
                        footnoteElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Add temporary highlight
                        footnoteElement.style.background = 'rgba(0, 102, 204, 0.1)';
                        setTimeout(() => {
                            footnoteElement.style.background = '';
                        }, 2000);
                    }
                });
            });
        }

        // Highlight comment in document
        function highlightCommentInDocument(commentNumber) {
            // Remove existing highlights
            document.querySelectorAll('.footnote-ref').forEach(ref => {
                ref.classList.remove('active');
            });
            
            // Highlight the specific footnote reference
            const ref = document.querySelector(`[data-comment-number="${commentNumber}"]`);
            if (ref) {
                ref.classList.add('active');
                ref.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Highlight comment in panel
        function highlightCommentInPanel(commentNumber) {
            // Remove existing highlights
            document.querySelectorAll('.comment-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Highlight the specific comment
            const commentItem = document.getElementById(`comment-${commentNumber}`);
            if (commentItem) {
                commentItem.classList.add('active');
                commentItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Toggle comment form
        function toggleCommentForm() {
            // This function is no longer used but kept for compatibility
        }

        // Cancel adding comment
        function cancelComment() {
            // This function is no longer used but kept for compatibility
        }

        // Add new comment (called from dialog)
        async function addComment(type, text, range) {
            console.log('addComment called with:', { type, text, range: range ? range.toString() : 'null' });
            
            if (!text) {
                alert('Please enter comment text');
                return;
            }
            
            if (!currentDocument) {
                alert('Please select a document first');
                return;
            }
            
            if (!range) {
                alert('No text selection found');
                return;
            }
            
            // Get the selected text for context
            const selectedText = range.toString().trim();
            console.log('Selected text for comment:', selectedText);
            
            if (!selectedText) {
                alert('No text was selected');
                return;
            }
            
            // Create new comment
            const newComment = {
                number: nextCommentNumber,
                type: type,
                text: text,
                author: userEmail,
                timestamp: Date.now(),
                ref: `^${nextCommentNumber}`,
                selectedText: selectedText,
                isComment: true  // Mark as comment footnote
            };
            
            console.log('Creating comment:', newComment);
            
            // Insert footnote reference at selection in the DOM (visual feedback)
            insertFootnoteAtRange(range, nextCommentNumber);
            
            // Add to current comments array
            currentComments.push(newComment);
            currentComments.sort((a, b) => a.number - b.number);
            
            // Save to GitHub with selected text context
            await saveCommentToGitHub(newComment);
            
            // Increment counter for next comment
            nextCommentNumber++;
            
            // Refresh display
            displayComments();
            addFootnoteClickHandlers();
            
            // Clear selection and range
            window.getSelection().removeAllRanges();
            currentCommentRange = null;
            
            console.log('Comment added successfully');
        }

        // Insert footnote reference at specific range
        function insertFootnoteAtRange(range, number) {
            // Create footnote reference element
            const footnoteRef = document.createElement('a');
            footnoteRef.href = `#comment-${number}`;
            footnoteRef.className = `footnote-ref ${currentCommentType}`;
            footnoteRef.dataset.commentNumber = number;
            footnoteRef.textContent = number;
            
            // Insert at end of selection
            range.collapse(false); // Move to end of selection
            range.insertNode(footnoteRef);
        }

        // Save comment to GitHub via API
        async function saveCommentToGitHub(comment) {
            try {
                const footnoteDefinition = `[^${comment.number}]: ${comment.type}:${comment.text}:${comment.author}:${comment.timestamp}`;
                
                console.log('Saving comment to GitHub:', footnoteDefinition);
                console.log('Selected text context:', comment.selectedText);
                
                // Get more context about the selection
                const docContent = document.getElementById('document-content');
                let beforeContext = '';
                let afterContext = '';
                
                if (docContent) {
                    const fullText = docContent.textContent || docContent.innerText;
                    const selectedIndex = fullText.indexOf(comment.selectedText);
                    if (selectedIndex !== -1) {
                        beforeContext = fullText.substring(Math.max(0, selectedIndex - 50), selectedIndex);
                        afterContext = fullText.substring(selectedIndex + comment.selectedText.length, selectedIndex + comment.selectedText.length + 50);
                    }
                }
                
                const response = await fetch('/api/save-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        docId: currentDocument.id,
                        comment: footnoteDefinition,
                        footnoteRef: `[^${comment.number}]`,
                        selectedText: comment.selectedText,
                        beforeContext: beforeContext,
                        afterContext: afterContext,
                        type: 'footnote',
                        action: 'add'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Failed to save comment to GitHub:', response.status, errorData);
                    alert('Failed to save comment to GitHub. It will be lost when you refresh.');
                    return;
                }
                
                const result = await response.json();
                console.log('Comment saved to GitHub successfully:', result);
                
            } catch (error) {
                console.error('Error saving comment to GitHub:', error);
                console.log('API endpoint not available - comment will be lost on refresh.');
            }
        }

        // Edit comment
        function editComment(commentNumber) {
            const comment = currentComments.find(c => c.number === commentNumber);
            if (!comment) return;
            
            // Show dialog with existing values
            currentCommentType = comment.type;
            showCommentDialog(comment.type, comment.text, true, commentNumber);
        }

        // Update existing comment
        async function updateComment(commentNumber, newText) {
            const comment = currentComments.find(c => c.number === commentNumber);
            if (!comment) return;
            
            if (!newText.trim()) {
                alert('Please enter comment text');
                return;
            }
            
            const oldComment = {...comment};
            comment.text = newText.trim();
            comment.timestamp = Date.now();
            
            // Update footnote reference styling (type doesn't change in edit)
            const ref = document.querySelector(`[data-comment-number="${commentNumber}"]`);
            if (ref) {
                ref.className = `footnote-ref ${comment.type}`;
            }
            
            // Save to GitHub
            await updateCommentInGitHub(oldComment, comment);
            
            // Refresh display
            displayComments();
        }

        // Update comment in GitHub
        async function updateCommentInGitHub(oldComment, newComment) {
            try {
                const oldFootnoteDefinition = `[^${oldComment.number}]: ${oldComment.type}:${oldComment.text}:${oldComment.author}:${oldComment.timestamp}`;
                const newFootnoteDefinition = `[^${newComment.number}]: ${newComment.type}:${newComment.text}:${newComment.author}:${newComment.timestamp}`;
                
                console.log('Updating comment in GitHub:', { old: oldFootnoteDefinition, new: newFootnoteDefinition });
                
                const response = await fetch('/api/save-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        docId: currentDocument.id,
                        oldComment: oldFootnoteDefinition,
                        comment: newFootnoteDefinition,
                        type: 'footnote',
                        action: 'update'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Failed to update comment in GitHub:', response.status, errorData);
                    return;
                }
                
                const result = await response.json();
                console.log('Comment updated in GitHub successfully:', result);
                
            } catch (error) {
                console.error('Error updating comment in GitHub:', error);
            }
        }

        // Delete comment
        async function deleteComment(commentNumber) {
            if (!confirm('Are you sure you want to delete this comment?')) return;
            
            const comment = currentComments.find(c => c.number === commentNumber);
            if (!comment) return;
            
            // Remove from array
            currentComments = currentComments.filter(c => c.number !== commentNumber);
            
            // Remove footnote reference from document
            const ref = document.querySelector(`[data-comment-number="${commentNumber}"]`);
            if (ref) {
                ref.remove();
            }
            
            // Save to GitHub
            await deleteCommentFromGitHub(comment);
            
            // Refresh display
            displayComments();
        }

        // Delete comment from GitHub
        async function deleteCommentFromGitHub(comment) {
            try {
                const footnoteDefinition = `[^${comment.number}]: ${comment.type}:${comment.text}:${comment.author}:${comment.timestamp}`;
                
                console.log('Deleting comment from GitHub:', footnoteDefinition);
                
                const response = await fetch('/api/save-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        docId: currentDocument.id,
                        comment: footnoteDefinition,
                        type: 'footnote',
                        action: 'delete'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Failed to delete comment from GitHub:', response.status, errorData);
                    return;
                }
                
                const result = await response.json();
                console.log('Comment deleted from GitHub successfully:', result);
                
            } catch (error) {
                console.error('Error deleting comment from GitHub:', error);
            }
        }

        // Modal functions
        function showOverview() {
            document.getElementById('overview-modal').classList.add('show');
        }

        function hideOverview() {
            document.getElementById('overview-modal').classList.remove('show');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
        
        // Comment menu and dialog handling
        document.addEventListener('DOMContentLoaded', function() {
            // Handle comment option clicks
            document.querySelectorAll('.comment-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const type = option.dataset.type;
                    const menu = document.getElementById('comment-menu');
                    const range = menu.selectionRange;
                    
                    if (!range) {
                        console.error('No selection range found');
                        return;
                    }
                    
                    currentCommentType = type;
                    currentCommentRange = range;
                    
                    if (type === 'approved') {
            // For approved comments, add immediately without dialog
                        addComment(type, 'Approved', range);
                        console.log('Selected text for approved comment:', range.toString());
                    } else {
                        // For questions and clarifications, show dialog
                        showCommentDialog(type);
                    }
                    
                    menu.classList.remove('show');
                    window.getSelection().removeAllRanges();
                });
            });
            
            // Hide comment menu on click outside
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('comment-menu');
                if (!menu.contains(e.target)) {
                    menu.classList.remove('show');
                }
            });
        });
        
        // Show comment dialog
        function showCommentDialog(type, existingText = '', isEdit = false, editCommentNumber = null) {
            console.log('Showing comment dialog for:', type, 'isEdit:', isEdit);
            
            const dialog = document.getElementById('comment-dialog');
            const title = document.getElementById('comment-dialog-title');
            const label = document.getElementById('comment-dialog-label');
            const textarea = document.getElementById('comment-dialog-text');
            
            if (type === 'question') {
                title.textContent = isEdit ? 'Edit Question' : 'Ask Question';
                label.textContent = 'Question text:';
                textarea.placeholder = 'What would you like to clarify or ask about this section?';
            } else if (type === 'clarification') {
                title.textContent = isEdit ? 'Edit Clarification' : 'Request Clarification';
                label.textContent = 'Clarification needed:';
                textarea.placeholder = 'What needs to be clarified or expanded in this section?';
            }
            
            textarea.value = existingText;
            dialog.style.display = 'block';
            
            // Store edit info on dialog element
            dialog.isEdit = isEdit;
            dialog.editCommentNumber = editCommentNumber;
            
            // Focus and select text
            setTimeout(() => {
                textarea.focus();
                if (existingText) {
                    textarea.select();
                }
            }, 100);
            
            console.log('Comment dialog shown');
        }
        
        // Hide comment dialog
        function hideCommentDialog() {
            console.log('Hiding comment dialog');
            const dialog = document.getElementById('comment-dialog');
            dialog.style.display = 'none';
            document.getElementById('comment-dialog-text').value = '';
            
            // Clear state
            currentCommentType = '';
            if (!dialog.isEdit) {
                currentCommentRange = null;
            }
            
            // Clear edit info
            dialog.isEdit = false;
            dialog.editCommentNumber = null;
        }
        
        // Submit comment from dialog
        function submitComment() {
            console.log('Submitting comment');
            
            const dialog = document.getElementById('comment-dialog');
            const textarea = document.getElementById('comment-dialog-text');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Please enter comment text');
                return;
            }
            
            if (dialog.isEdit && dialog.editCommentNumber) {
                // Update existing comment
                console.log('Updating existing comment:', dialog.editCommentNumber);
                updateComment(dialog.editCommentNumber, text);
            } else {
                // Add new comment
                console.log('Adding new comment with range:', currentCommentRange);
                if (currentCommentRange && currentCommentType) {
                    addComment(currentCommentType, text, currentCommentRange);
                } else {
                    console.error('Missing comment range or type');
                    alert('Error: Missing selection or comment type');
                    return;
                }
            }
            
            hideCommentDialog();
        }
    </script>
</body>
</html>